# 機能仕様書: Unity向けMCPサーバー仕様の精査と更新

**機能ブランチ**: `002-unity-mcp`  
**作成日**: 2025-09-05  
**ステータス**: 完了  
**入力**: ユーザー説明: "Unity向けMCPサーバー仕様の精査と更新"

## 実行フロー (main)
```
1. 入力からユーザー説明を解析
   → 空の場合: エラー "機能説明が提供されていません"
2. 説明から主要概念を抽出
   → 識別: アクター、アクション、データ、制約
3. 不明確な側面ごとに:
   → [要確認: 具体的な質問] でマーク
4. ユーザーシナリオとテストセクションを記入
   → 明確なユーザーフローがない場合: エラー "ユーザーシナリオを決定できません"
5. 機能要件を生成
   → 各要件はテスト可能である必要がある
   → 曖昧な要件をマーク
6. キーエンティティを識別（データが関与する場合）
7. レビューチェックリストを実行
   → [要確認] がある場合: 警告 "仕様に不確実性があります"
   → 実装詳細が見つかった場合: エラー "技術詳細を削除してください"
8. 戻り値: 成功（仕様が計画準備完了）
```

---

## ⚡ クイックガイドライン
- ✅ ユーザーが何を必要とし、なぜ必要かに焦点を当てる
- ❌ どのように実装するかは避ける（技術スタック、API、コード構造なし）
- 👥 開発者ではなく、ビジネス関係者向けに書かれている

### セクション要件
- **必須セクション**: すべての機能で完了する必要がある
- **オプションセクション**: 機能に関連する場合のみ含める
- セクションが適用されない場合は、完全に削除する（"N/A"として残さない）

---

## ユーザーシナリオとテスト *(必須)*

### 主要ユーザーストーリー
Unity開発者がコーディングエージェント（Claude、Copilot等）を使用して、Unityエディタを外部から制御し、ゲーム開発タスクを自動化できるようにする。開発者はエージェントを通じてシーンの操作、GameObjectの管理、アセットの操作、スクリプトの実行、ビルドの実行などを行い、開発効率を向上させる。

### 受け入れシナリオ
1. **前提** Unity開発者がUnityエディタを開いている状態、**操作** コーディングエージェントからシーン情報の取得を要求する、**結果** 現在のシーン構造とGameObject階層が返される
2. **前提** Unity開発者がGameObjectを作成したい、**操作** エージェント経由でGameObject作成コマンドを送信、**結果** 指定された名前とプロパティでGameObjectがシーンに追加される
3. **前提** 複数のシーンが存在する、**操作** エージェント経由でシーン切り替えコマンドを送信、**結果** 指定されたシーンがロードされ、アクティブになる
4. **前提** プレハブを作成したい、**操作** エージェント経由でプレハブ作成コマンドを送信、**結果** 指定されたGameObjectからプレハブが生成され、保存される
5. **前提** ゲームの動作を確認したい、**操作** エージェント経由でプレイモード開始コマンドを送信、**結果** Unityエディタがプレイモードに入り、ゲームが実行される
6. **前提** カスタムスクリプトを実行したい、**操作** エージェント経由でスクリプト実行コマンドを送信、**結果** 指定されたスクリプトがUnityエディタ内で実行され、結果が返される

### エッジケース
- Unityエディタが起動していない場合：エラーメッセージを返し、接続待機状態になる
- 複数のUnityエディタインスタンスが起動している場合：最初に起動したインスタンスに接続
- エディタがビジー状態（コンパイル中、インポート中）の場合：コマンドはキューに入れられ、ビジー状態解除後に実行
- 大量のGameObjectを一度に操作する際：バッチ処理により効率的に実行
- 悪意のあるスクリプトの実行：エディタ権限内での実行に制限

## 要件 *(必須)*

### 機能要件 (実装済み)
- **FR-001**: ✅ System MUST エディタの状態（プレイモード、編集モード、ポーズ状態）を取得できる
- **FR-002**: ✅ System MUST シーン内のGameObjectを階層構造として取得できる
- **FR-003**: ✅ System MUST GameObjectの作成、削除、変更（位置、回転、スケール）ができる
- **FR-004**: ✅ System MUST GameObjectにコンポーネントを追加、削除、設定変更できる
- **FR-005**: ✅ System MUST プレハブの作成、インスタンス化、保存ができる
- **FR-006**: ✅ System MUST シーンのロード、保存、新規作成ができる
- **FR-007**: ✅ System MUST プレイモードの開始、停止、ポーズができる
- **FR-008**: ✅ System MUST アセットのインポート、リフレッシュ、削除ができる
- **FR-009**: ✅ System MUST コンパイルの状態監視と完了待機ができる
- **FR-010**: ✅ System MUST エディタのコンソールログを取得、クリアできる
- **FR-011**: ✅ System MUST スクリーンショットの撮影ができる
- **FR-012**: ✅ System MUST カスタムスクリプトやエディタスクリプトを実行できる（C# LSP経由）
- **FR-013**: ✅ System MUST スクリプトの実行結果（戻り値、出力、エラー）を取得できる
- **FR-014**: ✅ System MUST 動画録画機能（Unity Recorder使用、mp4/webm形式）
- **FR-015**: ✅ System MUST 入力シミュレーション（キーボード、マウス、ゲームパッド、タッチ）
- **FR-016**: ✅ System MUST Animator制御機能（状態取得、パラメータ設定）
- **FR-017**: ✅ Users MUST エージェントから送信されたコマンドの実行結果を取得できる
- **FR-018**: ✅ System MUST エラー発生時の自動リトライ（最大3回、指数バックオフ）
- **FR-019**: ✅ System MUST ローカルホスト接続のみ許可（セキュリティ確保）
- **FR-020**: ✅ System MUST 同時接続数の制限（1接続のみ）
- **FR-021**: ✅ System MUST スクリプト実行の権限制御（エディタ権限内）
- **FR-022**: ✅ System MUST スクリプト実行のタイムアウト設定（デフォルト30秒）

### 追加実装済み機能
- **FR-023**: ✅ System MUST UI要素の検索、クリック、状態取得、値設定ができる
- **FR-024**: ✅ System MUST Input Systemのアクションマップ、バインディングの管理ができる
- **FR-025**: ✅ System MUST マテリアルの作成、編集ができる
- **FR-026**: ✅ System MUST メニューアイテムの実行ができる
- **FR-027**: ✅ System MUST エディタウィンドウの管理（開閉、フォーカス）ができる
- **FR-028**: ✅ System MUST タグとレイヤーの管理ができる
- **FR-029**: ✅ System MUST パッケージマネージャーの操作ができる
- **FR-030**: ✅ System MUST プロジェクト設定の取得、更新ができる
- **FR-031**: ✅ System MUST アセット依存関係の取得ができる
- **FR-032**: ✅ System MUST オブジェクト参照の解析ができる
- **FR-033**: ✅ System MUST コンポーネントによる検索ができる
- **FR-034**: ✅ System MUST シーン内容の分析ができる
- **FR-035**: ✅ System MUST C#スクリプトの構造化編集（シンボル検索、リファクタリング、コード生成）

### キーエンティティ *(データが関与する場合に含める)*
- **UnityEditor**: Unityエディタインスタンス、状態（編集/プレイ/ポーズ）、プロジェクト情報を保持
- **Scene**: シーンファイル、名前、パス、アクティブ状態、含まれるGameObject群
- **GameObject**: ゲームオブジェクト、名前、階層位置、Transform情報、アタッチされたコンポーネント群
- **Component**: コンポーネント、タイプ、プロパティ値、所属GameObject
- **Prefab**: プレハブアセット、パス、インスタンス化可能なGameObjectテンプレート
- **Asset**: アセットファイル、パス、タイプ、インポート状態、依存関係
- **Material**: マテリアルアセット、シェーダー、プロパティ値、テクスチャ参照
- **Script**: 実行可能なスクリプト、コード内容、実行コンテキスト、実行結果
- **Command**: エージェントから送信されるコマンド、タイプ、パラメータ、実行結果
- **ConsoleLog**: コンソールログエントリ、レベル（Info/Warning/Error）、メッセージ、スタックトレース
- **ScriptResult**: スクリプト実行結果、戻り値、標準出力、エラー情報、実行時間
- **UIElement**: UI要素、タイプ、位置、状態、値
- **InputAction**: Input Systemのアクション、バインディング、コントロールスキーム
- **Screenshot**: スクリーンショット画像、モード（ゲーム/シーン/両方）、保存パス
- **VideoRecording**: 動画録画、形式（mp4/webm）、フレームレート、解像度、保存パス

---

## レビューと受け入れチェックリスト
*ゲート: main() 実行中の自動チェック*

### コンテンツ品質
- [x] 実装詳細なし（言語、フレームワーク、API）
- [x] ユーザー価値とビジネスニーズに焦点を当てている
- [x] 技術者以外のステークホルダー向けに書かれている
- [x] すべての必須セクションが完了

### 要件の完全性
- [x] [要確認] マーカーが残っていない
- [x] 要件はテスト可能で曖昧さがない
- [x] 成功基準は測定可能
- [x] スコープが明確に限定されている
- [x] 依存関係と前提条件が特定されている

---

## 実行ステータス
*main() の処理中に更新*

- [x] ユーザー説明を解析済み
- [x] 主要概念を抽出済み
- [x] 曖昧さを解決済み
- [x] ユーザーシナリオを定義済み
- [x] 要件を生成済み
- [x] エンティティを識別済み
- [x] レビューチェックリストをパス

---

## 実装状況サマリー

### 完全実装済み領域
1. **GameObject管理**: 作成、削除、変更、階層操作
2. **コンポーネント管理**: 追加、削除、設定変更、一覧取得
3. **シーン管理**: ロード、保存、作成、切り替え、情報取得
4. **アセット管理**: プレハブ、マテリアル、依存関係、インポート設定
5. **プレイモード制御**: 再生、停止、ポーズ、状態取得
6. **コンソール操作**: ログ取得、クリア
7. **スクリーンショット/動画**: 撮影、録画（Unity Recorder）
8. **入力シミュレーション**: キーボード、マウス、ゲームパッド、タッチ
9. **UI操作**: 要素検索、クリック、状態取得、値設定
10. **エディタ拡張**: メニュー実行、ウィンドウ管理、タグ/レイヤー管理
11. **スクリプト操作**: C# LSP経由での構造化編集、リファクタリング
12. **分析機能**: シーン分析、オブジェクト参照、コンポーネント検索

### 技術的特徴
- **MCP (Model Context Protocol)** による標準化されたツールインターフェース
- **ワークスペース管理**: 固定パス解決、config.json による設定
- **エラーハンドリング**: 自動リトライ、指数バックオフ
- **セキュリティ**: ローカルホスト接続限定、エディタ権限内実行

---